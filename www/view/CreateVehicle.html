<div data-role="view" data-title="Create Vehicle Check" data-show="CreateVehicleLayoutDataShow" data-after-show="CreateVehicleLayoutDataAfterShow" id="CreateVehicleLayoutPage" data-use-native-scrolling="true">
    <header data-role="header">
        <div data-role="navbar" class="km-accent">
            <button style="float:left;margin-top:2%;border-style:none;" onclick="window.history.back()" class="VehicleDetailPageMDLName mdl-button mdl-js-button mdl-button--icon">
                <i class="material-icons">keyboard_backspace</i>
            </button>
            <span data-role="view-title"></span>
            <span onclick="app.navigate('view/OfflineData.html');" class="OfflineDataItemCount badge badge-notify" style="border-radius:0 !important;top:0 !important;left:0 !important;float:right;"></span>
            <button id="homePageBtn" onclick="app.navigate('view/HomePage.html');" data-align="right" class="VehiclePageMDL headerIconStyleForAll mdl-button mdl-js-button mdl-button--icon">
                <i class="material-icons" style="color:white;">home</i>
            </button>
            <button class="VehiclePageMDL headerIconStyleForAll mdl-button mdl-js-button mdl-button--icon" data-align="right" onclick="gotoShowImageFromInspection()">
                <i class="material-icons" style="color:white;">photo_camera</i>
            </button>
            <!--i style="border-style:none;color:white;float:right;margin-left:15px;margin-right:15px;width: 10%;padding:3px;">photo_camera</i-->

        </div>
    </header>
    <center>
        <div id="createVehicle_Disclaimer"></div>
    </center><br/>
    <div id="CreateVehicleLayout">
    </div>
    <center>
        <!--button data-role="button" data-click="CreateAnalysis">Create</button-->
        <button id="CreateVehicleLayoutMDLButton" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" onClick="Createvehicle();" style="font-weight:bold;">
            CREATE
        </button>
    </center>
</div>
<script>
    var VehicleRecordId = '';

    function CreateVehicleLayoutDataShow() {
        CountNumberOfOflineItem();


        VehicleRecordId = '';
        try {
            if (vehicleRecordType[0]["recordTypeId"]) {
                VehicleRecordId = vehicleRecordType[0]["recordTypeId"];
            } else {
                VehicleRecordId = vehicleRecordType[0].VehicleRecordTypeId
            }

        } catch (err) {
            StoreError(err);
            console.log(err);
        }
        console.log(VehicleRecordId);
        if (VehicleRecordId) {
            app.db.transaction(function(tx) {
                tx.executeSql("Select * from vehicleRecordType where recordid=?", [VehicleRecordId],
                    function(tx, rs) {
                        if (rs.rows.length) {
                            var Layoutdata = JSON.parse(rs.rows.item(0)['jsondata']);
                            console.log('vehicle Record Type Layout', Layoutdata);
                            $('#CreateVehicleLayout').html(VehicleLayoutGenerator(Layoutdata));
                            // CreateEventLayoutDataAfterShow();
                        } else {
                            app.toastMessage('This record type is not found, Please refresh data', 'long');
                        }
                    },
                    function(tx, error) {
                        StoreError(error);
                        alert(error.message);
                    });

            });
        }
        if (ButtonSettings.STKR__Vehicle_Checklist_Text__c) {
            if (ButtonSettings.STKR__Vehicle_Checklist_Text__c !== null) {
                $("#createVehicle_Disclaimer").addClass("createVehicle_DisclaimerClass")
                $("#createVehicle_Disclaimer").text(ButtonSettings.STKR__Vehicle_Checklist_Text__c);
            }
        }
    }




    function VehicleLayoutGenerator(Layoutdata) {
        var VehicleHTML = '';
        //x=1 to exclude information section; and loop to InspectionPageDetailData['editLayoutSections'].length-1 to exclude system information
        for (var x = 0; x < Layoutdata['editLayoutSections'].length; x++) {
            var layoutRows = Layoutdata['editLayoutSections'][x]['layoutRows'];
            var layoutHeader = Layoutdata['editLayoutSections'][x]['heading'];
            VehicleHTML += '<center><h5>' + layoutHeader + '</h5></center>';
            VehicleHTML += '<div class="mdl-shadow--2dp" style="margin:2%;padding:2%;background-color:#fff; border-radius: 10px;">';
            for (var j = 0; j < layoutRows.length; j++) {
                var layoutItems = layoutRows[j]['layoutItems'];
                for (var y = 0; y < layoutItems.length; y++) {
                    var layoutComponents = layoutItems[y]['layoutComponents'][0];
                    if (layoutItems[y]['editableForUpdate'] || (layoutItems[y]['editableForNew'] && layoutComponents['details']['label'] == "Vehicle")) {
                        // var layoutComponents = layoutItems[y]['layoutComponents'][0];
                        try {
                            var label = layoutComponents['details']['label'];
                            var htmlid = layoutComponents['details']['name'];
                            var dataType = layoutComponents['details']['type'];
                            var nillable = layoutComponents['details']['nillable'];
                            var precision = layoutComponents['details']['precision'];
                            var scale = layoutComponents['details']['scale'];
                            var max = Math.pow(10, (precision - scale)) - 1;
                            var step = Math.pow(10, -1 * scale);
                            var htmlrequired = nillable ? '' : 'required';
                            var maxlength = layoutComponents['details']['length'];
                            var newhtmlrequired = layoutItems[y]['required'] ? 'required' : '';
                            if (dataType === 'string') {
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                if (newhtmlrequired === 'required') {
                                    VehicleHTML += '<label style="color:rgb(215,0,0);font-size: 16px;"  for="' + htmlid + '"">' + label + '</label>';
                                } else {
                                    VehicleHTML += '<label for="' + htmlid + '"">' + label + '</label>';
                                }
                                VehicleHTML += '<input type="text" name="VehicleLayoutName" class="VehiclePageMDL mdl-textfield__input" id="' + htmlid + '" maxlength="' + maxlength + '" ' + newhtmlrequired + '>';
                                VehicleHTML += '</div><br>';
                            } else if (dataType === 'reference') {
                                //if (navigator.onLine) {
                                if (htmlid === 'STKR__Vehicle__c') {
                                    VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                    if (newhtmlrequired === 'required')
                                        VehicleHTML += '<label style="color:rgb(215,0,0);font-size: 16px;" for="' + htmlid + '">' + label + '</label>';
                                    else
                                        VehicleHTML += '<label style="color:rgb(0,188,212);font-size: 16px;" for="' + htmlid + '">' + label + '</label>';
                                    VehicleHTML += '<select name="VehicleLayoutName" id="' + htmlid + '" class="VehiclePageMDL mdl-textfield__input"' + newhtmlrequired + '>';
                                    VehicleHTML += '<option value="">None</option>';
                                    for (var optionvalues = 0; optionvalues < vehicleData.length; optionvalues++) {
                                        VehicleHTML += '<option value="' + vehicleData[optionvalues]['Id'] + '">' + vehicleData[optionvalues]['Name'] + '</option>';
                                    }
                                    VehicleHTML += '</select>';
                                    VehicleHTML += '</div></br>';
                                }
                                //} 
                            } else if (dataType === 'double') {
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                VehicleHTML += '<label class="VehiclePageMDL mdl-textfield__label" for="' + htmlid + '"">' + label + '</label>';
                                VehicleHTML += '<input type="number" name="VehicleLayoutName" class="VehiclePageMDL mdl-textfield__input" max="' + max + '" step="' + step + '" id="' + htmlid + '"' + newhtmlrequired + '>';
                                VehicleHTML += '</div><br>';
                            } else if (dataType === 'picklist') {
                                if (newhtmlrequired === 'required')
                                    VehicleHTML += '<label style="color:rgb(215,0,0);font-size: 16px;" for="' + htmlid + '">' + label + '</label><br/>';
                                else
                                    VehicleHTML += '<label style="color:rgb(0,188,212);font-size: 16px;" for="' + htmlid + '">' + label + '</label><br/>';
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                VehicleHTML += '<select name="VehicleLayoutName" id="' + htmlid + '" class="VehiclePageMDL mdl-textfield__input"' + newhtmlrequired + '>';
                                // Start 
                                VehicleHTML += '<option value="">--None--</option>';

                                for (var optionvalues = 0; optionvalues < layoutComponents['details']['picklistValues'].length; optionvalues++) {
                                    if (layoutComponents['details']['picklistValues'][optionvalues]['defaultValue']) {
                                        VehicleHTML += '<option value="' + layoutComponents['details']['picklistValues'][optionvalues]['value'] + '" selected>' + layoutComponents['details']['picklistValues'][optionvalues]['value'] + '</option>';

                                    } else {
                                        VehicleHTML += '<option value="' + layoutComponents['details']['picklistValues'][optionvalues]['value'] + '">' + layoutComponents['details']['picklistValues'][optionvalues]['value'] + '</option>';
                                    }
                                }
                                // End

                                VehicleHTML += '</select>';
                                VehicleHTML += '</div><br>';
                            } else if (dataType === 'date') {
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield">';
                                VehicleHTML += '<label style="color: rgb(0,188,212);font-size: 16px;" for="' + htmlid + '">' + label + '</label>';
                                VehicleHTML += '<input class="VehiclePageMDL mdl-textfield__input" type="date" name="VehicleLayoutName" id="' + htmlid + '"' + newhtmlrequired + '/>';
                                VehicleHTML += '</div><br>';
                            } else if (dataType === 'textarea') {
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                VehicleHTML += '<textarea name="VehicleLayoutName" id="' + htmlid + '"  class="mdl-textfield__input"  type="text" rows="5" maxlength="' + maxlength + '" ' + newhtmlrequired + '></textarea>';
                                VehicleHTML += '<label class="VehiclePageMDL mdl-textfield__label" for="' + htmlid + '">' + label + '</label>';
                                VehicleHTML += '</div><br>';
                            } else if (dataType === 'datetime') {
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield">';
                                VehicleHTML += '<label style="color: rgb(0,188,212);font-size: 16px;" for="' + htmlid + '">' + label + '</label>';
                                VehicleHTML += '<input class="mdl-textfield__input" type="date" name="VehicleLayoutName" id="' + htmlid + '"' + newhtmlrequired + '/>';
                                VehicleHTML += '</div> <br>';
                            } else if (dataType === 'boolean') {
                                if (device.platform === 'Android') {
                                    VehicleHTML += '<input name="VehicleLayoutName" type="checkbox" id="' + htmlid + '"' + newhtmlrequired + '>';
                                    VehicleHTML += '<label for="' + htmlid + '">';
                                    VehicleHTML += '<span>' + label + '</span>';
                                    VehicleHTML += '</label><br>';
                                } else if (device.platform === 'iOS') {
                                    VehicleHTML += '<input name="VehicleLayoutName" type="checkbox" id="' + htmlid + '"' + newhtmlrequired + '>';
                                    VehicleHTML += '<label for="' + htmlid + '">';
                                    VehicleHTML += '<span>' + label + '</span>';
                                    VehicleHTML += '</label><br>';
                                }
                            } else if (dataType === 'email') {
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                VehicleHTML += '<input type="email" name="VehicleLayoutName" class="VehiclePageMDL mdl-textfield__input" id="' + htmlid + '"' + newhtmlrequired + '>';
                                VehicleHTML += '<label class="VehiclePageMDL mdl-textfield__label" for="' + htmlid + '"">' + label + '</label>';
                                VehicleHTML += '</div><br>';
                            } else if (dataType === 'multipicklist') {
                                if (newhtmlrequired === 'required')
                                    VehicleHTML += '<label style="color:rgb(215,0,0);font-size: 16px;" for="' + htmlid + '">' + label + '</label><br/>';
                                else
                                    VehicleHTML += '<label style="color:rgb(0,188,212);font-size: 16px;" for="' + htmlid + '">' + label + '</label><br/>';
                                VehicleHTML += '<div class="VehiclePageMDL mdl-textfield mdl-js-textfield mdl-textfield--floating-label">';
                                VehicleHTML += '<select class="VehiclePageMDL mdl-textfield__input" name="VehicleLayoutName" id="' + htmlid + '" multiple' + newhtmlrequired + '>';
                                for (var optionvalues = 0; optionvalues < layoutComponents['details']['picklistValues'].length; optionvalues++) {
                                    VehicleHTML += '<option value="' + layoutComponents['details']['picklistValues'][optionvalues]['value'] + '">' + layoutComponents['details']['picklistValues'][optionvalues]['value'] + '</option>';
                                }
                                VehicleHTML += '</select>';
                                VehicleHTML += '</div><br>';
                            } else {
                                console.log('In else', dataType);
                            }
                        } catch (e) {}
                    }
                }
            }
            VehicleHTML += '</div>';
        }
        return VehicleHTML;
    }



    function CreateVehicleLayoutDataAfterShow() {
        if (device.platform == "Android") {
            componentHandler.upgradeElements(document.getElementsByClassName('VehiclePageMDL'));
        }
        componentHandler.upgradeElements(document.getElementsByClassName('mdl-textfield'));
        componentHandler.upgradeElements(document.getElementsByClassName('mdl-textfield__input'));
        componentHandler.upgradeElements(document.getElementsByClassName('mdl-textfield__label'));
    }

    function gotoShowImageFromInspection() {
        var options = {
            'androidTheme': window.plugins.actionsheet.ANDROID_THEMES.THEME_HOLO_DARK,
            'buttonLabels': ['OK', 'Cancel'],
            'title': 'You would not be able to update this page later'
        };
        window.plugins.actionsheet.show(options, function(buttonIndex) {
            if (buttonIndex === 1) {
                var retVal = Createvehicle('uploadimage');
            } else if (buttonIndex === 2) {}
        });

    }


    function Createvehicle(whereto) {
        app.pane.loader.show();
        var VehicleLayoutHTMLComponents = $("[name='VehicleLayoutName']");
        console.log(VehicleLayoutHTMLComponents);
        var datatoupload = {};
        for (var i = 0; i < VehicleLayoutHTMLComponents.length; i++) {
            var values = '';
            if (VehicleLayoutHTMLComponents[i]['tagName'] === 'SELECT') {
                var selectedOptions = $('#' + VehicleLayoutHTMLComponents[i]['id'])[0]['selectedOptions'];
                for (var j = 0; j < selectedOptions.length; j++) {
                    console.log(selectedOptions[j].value);
                    values += selectedOptions[j].value + ';';
                }
                values = values.substring(0, values.length - 1);
            } else if (VehicleLayoutHTMLComponents[i]['type'] === "checkbox") {
                values = $('#' + VehicleLayoutHTMLComponents[i]['id'] + '[name="VehicleLayoutName"]').prop('checked');
            } else if (VehicleLayoutHTMLComponents[i]['type'] === "date") {
                values = $('#' + VehicleLayoutHTMLComponents[i]['id']).val();
                if (!values) {
                    values = null;
                }
            } else {
                values = $('#' + VehicleLayoutHTMLComponents[i]['id'] + '[name="VehicleLayoutName"]').val()
            }
            datatoupload[VehicleLayoutHTMLComponents[i]['id']] = values;
            if (VehicleLayoutHTMLComponents[i]['required'] && !values) {
                app.toastMessage('Please fill all required fields', 'long');
                app.pane.loader.hide();
                return;
            }
        }
        var timestamp = (new Date().getTime()).toString();
        datatoupload['STKR__MobileUniqueId__c'] = ";MobileVehicle;" + timestamp;
        //  datatoupload['OwnerId'] = creds.UserID;
        // datatoupload['STKR__Driver__c'] = InspectionPageDetailData['Id'];
        //datatoupload['RecordTypeId'] = VehicleRecordId;
        console.log('Data to upload', datatoupload);

        //datatoupload['STKR__Driver__c'] = ResourceId;
        // Check whether device is online or not
        if (AppIsOnline) {
            //Device is online
            jsconn.sobject("STKR__Vehicle_checks__c").create(datatoupload, function(err, ret) {
                if (err || !ret.success) {
                    app.pane.loader.hide();
                    app.toastMessage('Error occured, Please check Error log page', 'long');
                    StoreError(err);
                    return console.error(err, ret);
                }
                console.log('Updated Successfully : ' + ret.id);
                datatoupload['Id'] = ret.id;
                console.log('datatoupload after creating on salesforce', datatoupload);

                app.toastMessage('New Vehicle created', 'long');
                app.pane.loader.hide();
                if (whereto == 'uploadimage') {
                    NavigateToImageAttachPage(whereto, datatoupload);
                } else {
                    window.history.back();
                }
                // Ask Ian about the conditions


            });
        } else {
            // Device is offline
            // Store in DataToUpdate table
            var timestamp = (new Date().getTime()).toString();
            datatoupload['Id'] = timestamp;
            var data = {};


            data = {
                JsonData: JSON.stringify(datatoupload),
                ObjectName: 'STKR__Vehicle_checks__c',
                Updated: 'newRecord',
                UpdateOrInsert: 'insert',
                UserId: creds.UserID,
                RecordId: timestamp /* For Insertion */
            }

            //AnalysisData.push(datatoupload);
            app.insertRecord('DataToUpdate', data);
            app.toastMessage('New Vehicle stored offline', 'long');
            app.pane.loader.hide();
            if (whereto == 'uploadimage') {
                NavigateToImageAttachPage(whereto, datatoupload);
            } else {
                window.history.back();
            }

        }
    }

    function NavigateToImageAttachPage(whereto, VehicleData) {
        var PageURL = "view/ShowImage.html?ImageComingFrom=Vehicle";

        if (VehicleData['Id']) {
            PageURL += "&vehicleId=" + VehicleData['Id'];
        }

        if (VehicleData['Id'] &&
            VehicleData['Id'].length < 18 &&
            VehicleData['STKR__MobileUniqueId__c']) {
            PageURL += "&vehicleExternalId=" + VehicleData['STKR__MobileUniqueId__c'];
        }

        app.navigate(PageURL);
    }
</script>

<style>
    .createVehicle_DisclaimerClass {
        background-color: red;
        color: white;
        font-weight: bold;
        padding: 2px;
        border-style: solid;
        border-bottom-width: 2px;
        border-top-width: 2px;
    }
</style>